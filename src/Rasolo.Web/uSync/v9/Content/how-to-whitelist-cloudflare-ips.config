<?xml version="1.0" encoding="utf-8"?>
<Content Key="65e34cdf-984c-40b9-b5be-24240f32abb5" Alias="How to whitelist Cloudflare ips" Level="4">
  <Info>
    <Parent Key="3d755841-c847-4721-82c8-1a60407eac63">IT</Parent>
    <Path>/Start/Blogs/IT/HowToWhitelistCloudflareIps</Path>
    <Trashed>false</Trashed>
    <ContentType>blogPostPage</ContentType>
    <CreateDate>2020-02-21T20:00:06</CreateDate>
    <NodeName Default="How to whitelist Cloudflare ips" />
    <SortOrder>8</SortOrder>
    <Published Default="true" />
    <Schedule />
    <Template Key="58a30bec-739d-43b7-b66f-85ca2620dd3e">BlogPostPage</Template>
  </Info>
  <Properties>
    <heroImage>
      <Value><![CDATA[]]></Value>
    </heroImage>
    <mainBody>
      <Value><![CDATA[<p>First go to this url to find out the ip ranges Cloudflare has: <a href="https://www.cloudflare.com/ips/">https://www.cloudflare.com/ips/</a>. The ips will look something like this:</p>
<pre>173.245.48.0/20</pre>
<p>I did not know what the /20 meant so I simply removed it when whitelisting and of course it did not work. For all the ips listed you have to find out the subnet mask which you can do with the CIDR which is the /20 in this case. You can use this subnet calculator site in order to find out the subnet mask: <a href="https://mxtoolbox.com/subnetcalculator.aspx">https://mxtoolbox.com/subnetcalculator.aspx</a>. Input the ip address and select the CIDR (the number after the forward slash) in order to retrieve the subnet mask.</p>
<p>Since I use dotnet with web.config and ipsecurity, the final whitelisting result will look like this:</p>
<pre>&lt;add allowed="true" ipAddress="173.245.48.0" subnetMask="255.255.240.0" /&gt;<br />&lt;add allowed="true" ipAddress="103.21.244.0" subnetMask="255.255.252.0" /&gt;<br />&lt;add allowed="true" ipAddress="103.22.200.0" subnetMask="255.255.252.0" /&gt;<br />&lt;add allowed="true" ipAddress="103.31.4.0" subnetMask="255.255.252.0" /&gt;<br />&lt;add allowed="true" ipAddress="141.101.64.0" subnetMask="255.255.192.0" /&gt;<br />&lt;add allowed="true" ipAddress="108.162.192.0" subnetMask="255.255.192.0" /&gt;<br />&lt;add allowed="true" ipAddress="190.93.240.0" subnetMask="255.255.240.0" /&gt;<br />&lt;add allowed="true" ipAddress="188.114.96.0" subnetMask="255.255.240.0" /&gt;<br />&lt;add allowed="true" ipAddress="197.234.240.0" subnetMask="255.255.252.0" /&gt;<br />&lt;add allowed="true" ipAddress="198.41.128.0" subnetMask="255.255.128.0" /&gt;<br />&lt;add allowed="true" ipAddress="162.158.0.0" subnetMask="255.254.0.0" /&gt;<br />&lt;add allowed="true" ipAddress="104.16.0.0" subnetMask="255.240.0.0" /&gt;<br />&lt;add allowed="true" ipAddress="172.64.0.0" subnetMask="255.248.0.0" /&gt;<br />&lt;add allowed="true" ipAddress="131.0.72.0" subnetMask="255.255.252.0" /&gt;</pre>
<p>the example above will probably get outdated eventually as Cloudflare updates their ip addresses. But now you know how to retrieve the new subnet masks.</p>
<p>In my case I wanted to whitelist Cloudflare in order to gain access to this sites back office editor/admin section. I also had to whitelist my own ips such as my home network in order to gain access.</p>
<p>My final whitelisting looks like this:</p>
<pre>&lt;location path="umbraco"&gt;<br />&lt;system.webServer&gt;<br />&lt;security&gt;<br />&lt;ipSecurity enableProxyMode="true" allowUnlisted="false" denyAction="Unauthorized"&gt;<br />&lt;add allowed="true" ipAddress="{privateIp}" /&gt;<br />&lt;add allowed="true" ipAddress="{privateIp}" /&gt;<br />&lt;add allowed="true" ipAddress="{privateIp}" /&gt;<br />&lt;!-- Cloudflare whitelist--&gt;<br />&lt;add allowed="true" ipAddress="173.245.48.0" subnetMask="255.255.240.0" /&gt;<br />&lt;add allowed="true" ipAddress="103.21.244.0" subnetMask="255.255.252.0" /&gt;<br />&lt;add allowed="true" ipAddress="103.22.200.0" subnetMask="255.255.252.0" /&gt;<br />&lt;add allowed="true" ipAddress="103.31.4.0" subnetMask="255.255.252.0" /&gt;<br />&lt;add allowed="true" ipAddress="141.101.64.0" subnetMask="255.255.192.0" /&gt;<br />&lt;add allowed="true" ipAddress="108.162.192.0" subnetMask="255.255.192.0" /&gt;<br />&lt;add allowed="true" ipAddress="190.93.240.0" subnetMask="255.255.240.0" /&gt;<br />&lt;add allowed="true" ipAddress="188.114.96.0" subnetMask="255.255.240.0" /&gt;<br />&lt;add allowed="true" ipAddress="197.234.240.0" subnetMask="255.255.252.0" /&gt;<br />&lt;add allowed="true" ipAddress="198.41.128.0" subnetMask="255.255.128.0" /&gt;<br />&lt;add allowed="true" ipAddress="162.158.0.0" subnetMask="255.254.0.0" /&gt;<br />&lt;add allowed="true" ipAddress="104.16.0.0" subnetMask="255.240.0.0" /&gt;<br />&lt;add allowed="true" ipAddress="172.64.0.0" subnetMask="255.248.0.0" /&gt;<br />&lt;add allowed="true" ipAddress="131.0.72.0" subnetMask="255.255.252.0" /&gt;<br />&lt;/ipSecurity&gt;<br />&lt;/security&gt;<br />&lt;/system.webServer&gt;<br />&lt;/location&gt;</pre>
<p> </p>
<p>So in dotnet you also have to enable proxy mode in the ip security element like so:</p>
<pre>&lt;ipSecurity enableProxyMode="true" ..</pre>]]></Value>
    </mainBody>
    <metaDescription>
      <Value><![CDATA[]]></Value>
    </metaDescription>
    <metaTitle>
      <Value><![CDATA[]]></Value>
    </metaTitle>
    <preamble>
      <Value><![CDATA[In order for Cloudflare to work on your Azure website you have to whitelist the ip addresses that Cloudflare uses.]]></Value>
    </preamble>
    <teaserHeading>
      <Value><![CDATA[]]></Value>
    </teaserHeading>
    <teaserMedia>
      <Value><![CDATA[{"src":"/media/pehfnp31/bingimageoftheday.jpg","focalPoint":{"left":0.44,"top":0.562962962962963},"crops":[{"alias":"startPage","width":500,"height":500,"coordinates":null}]}]]></Value>
    </teaserMedia>
    <teaserMediaAltText>
      <Value><![CDATA[]]></Value>
    </teaserMediaAltText>
    <title>
      <Value><![CDATA[How to whitelist Cloudflare IPs]]></Value>
    </title>
  </Properties>
</Content>